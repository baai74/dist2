let M=null,te=[],_=[],h=null,W=null,S=null,I=null,ne=null,N=null,v=null,j=12,U=0;const J=["Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.5249.119 Safari/537.36","Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; AS; rv:11.0) like Gecko","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Edge/12.246","Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:104.0) Gecko/20100101 Firefox/104.0","Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.150 Safari/537.36","Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.85 Safari/537.36","Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; AS; rv:11.0) like Gecko"];let x=[],P=[];const me=260,fe=10;let Q=null,X=null;document.addEventListener("DOMContentLoaded",async()=>{alert("ok")});const he=()=>{console.log("mounted"),N&&N.isEnabled&&(Z()?ye():Z()||alert("Refresh the and check out the zip code"))};(async()=>{try{const e=await le();e&&(N=e),await b(100),he()}catch(e){console.log(e)}})();async function ge(){try{const e=await le();e&&(N=e);return}catch{}}async function ye(){N||await ge();let e=N.showCompetition,t=N.showProductinfo;ne=e;const n=document.querySelector(".s-main-slot"),r={childList:!0,subtree:!0},a=s=>{for(const i of s)i.type==="childList"&&i.addedNodes.forEach(async u=>{u.nodeType===Node.ELEMENT_NODE&&u.hasAttribute("data-asin")&&u.getAttribute("data-asin").length>4&&(t&&Ce(u.getAttribute("data-asin")),await b(100),Ae())})},o=new MutationObserver(a);n&&o.observe(n,r),t&&we(),e&&ve()}async function Z(){const e=await He(),t=3;let n=e?e.refresh:0,r=!1;for(;!r&&n<t;)try{const a=document.querySelector("#nav-packard-glow-loc-icon");if(r=a&&a.offsetParent!==null,r)break;n++,e.refresh=n,await ee(e),location.reload(!0);return}catch{console.warn(`Error trying to load zipcode ${n+1}`)}return r||(console.error("Check the zipcode please!"),e.refresh=0,await ee(e)),r}async function we(){try{await be()}catch{}}async function be(){const e=document.querySelectorAll('.s-result-item.s-asin [data-cy="image-container"]');if(e.length===0)return;h||(h=await A("loading.gif"));const t=()=>{const n=document.createElement("div");return n.classList.add("emr_details_container"),n.innerHTML=`
            <p>Publication Date:<b class="date"><img src='${h}'/></b></p>
            <p>BSR (Best Sellers Rank):<b class="bsr">N/A</b></p>
            <p>Asin:<b class="asin"><img src='${h}'/></b></p>
        `,n};e.forEach(n=>{const r=t();n.parentElement.insertBefore(r,n)}),await b(500),setTimeout(()=>{Se()},ne?1e3:100)}async function ve(){const e=document.querySelector('[data-component-type="s-search-results"]');if(!e)return;const t=e.parentElement,n=document.createElement("div");n.classList.add("emr","item-container-row"),h||(h=await A("loading.gif")),W||(W=await A("logo.png"));const r=()=>{const a=document.createElement("button");return a.classList.add("multiloader"),a.textContent="Niche Search",a.outerHTML};n.innerHTML=`
    <img class="navLogo" src="${W}" alt="Nav Logo"/>
    <p class="msg">
        Products: <b class="resultProduct"><img src="${h}" alt="Loading..."/></b>
    </p>
    <div class="action-buttons">
      <button class="winner">Winners</button>
      ${r()}
    </div>
    
    `,t.prepend(n),document.querySelector(".emr.item-container-row .multiloader").addEventListener("click",ze),document.querySelector(".emr.item-container-row .winner").addEventListener("click",Ve),qe()}async function Ce(e){const t=document.querySelector(`.s-result-item.s-asin[data-asin="${e}"]`);if(t.querySelector(".emr_details_container"))return;h||(h=await A("loading.gif"));const n=()=>{const a=document.createElement("div");return a.classList.add("emr_details_container"),a.innerHTML=`
            <p>Published:<b class="date"><img src='${h}'/></b></p>
            <p>Rank(BSR):<b class="bsr">N/A</p>
            <p>Asin:<b class="asin"><img src='${h}'/></b></p>
        `,a},r=t.querySelector('[data-cy="image-container"]');r.parentElement.insertBefore(n(),r);for(const a of te)if(a.asin===e){const o=document.querySelector(`.s-result-item.s-asin[data-asin="${e}"]`);if(e.length>4){o.querySelector(".emr_details_container .date").textContent=F(a.date),o.querySelector(".emr_details_container .asin").textContent=a.asin;return}}re(e)}async function re(e){let t=await G(e,0);!t||t==="undefined"||(Pe(t,e),t=null)}async function Se(){try{let e=await xe();await b(1e3),await Ee(e)}catch(e){console.error("Error fetching product data:",e)}}async function xe(){const e=new Set;return document.querySelectorAll(".s-result-item.s-asin").forEach(t=>{const n=t.getAttribute("data-asin");n&&n.length>4&&e.add(n)}),Array.from(e)}async function Ee(e){for(const t of e)re(t)}async function Pe(e,t){try{let n=R(e),r=Y(n,t);const a=document.querySelectorAll(`.s-result-item.s-asin[data-asin="${t}"]`);a.length>0&&t.length>4&&(a.forEach(o=>{const s=o.querySelector(".emr_details_container");s&&(s.querySelector(".date").textContent=F(r.date),s.querySelector(".asin").textContent=r.asin)}),te.push(r)),n=r=null,await b(20)}catch(n){console.error("Error processing product details",n)}}function L(e,t="N/A"){return e&&e!==null?e:t}function Y(e,t){try{let n=`${M}dp/${t}`;/^https?:\/\//i.test(n)||(n=`https://${n}`);let r=L(Le(e)),a=L(Me(e)),o=L(H(e,"Date")),s=L(H(e,"Best Sellers")),i=L(oe(t)),l=L(Ie(e)),u=L(H(e,"Manufacturer")),c=new at(r,n,a,o,s,i,l,u,"N/A");return r=null,a=null,o=null,s=null,i=null,l=null,u=null,c}catch(n){console.error("Error extracting product info.",n)}return null}async function ae(e){if(!e)return null;e=e.replace(/<\/?title>/gi,"").trim();let t=`${M}/s?k=${encodeURIComponent(e).replace(/%20/g,"+")}`;return/^https?:\/\//i.test(t)||(t=`https://${t}`),await ie(t)}function Le(e){var n;const t=["Camiseta","shirt","Sleeve","T-shirt","Maglietta","hoodie","Sweat à Capuche","Sudadera con Capucha","Felpa con Cappuccio","Débardeur","Camiseta sin Mangas","tanktop","tank top","tank-top","Canotta","Throw Pillow","Camiseta Cuello V","V-Neck","V-Ausschnitt","T-Shirt avec Col en V","Maglietta con Collo a V","Sweatshirt","Tumbler"];try{const r=e.title,a=(n=e.title)==null?void 0:n.split(":");for(const o of a)for(const s of t)if(o.toLowerCase().includes(s.toLowerCase())){if(o.toLowerCase().includes("amazon.")&&o.toLowerCase().includes("|")){const i=o.split("|");for(const l of i)if(l.toLowerCase().includes(s.toLowerCase()))return l.trim().replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"")}return o.trim().replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"")}return e=null,a[0].trim()}catch{}return null}function Me(e){var t;try{return((t=e.querySelector("#imgTagWrapperId img"))==null?void 0:t.getAttribute("source").trim().replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,""))||null}catch{console.error("No image found for product check the zip code!")}return null}function H(e,t){var n,r;try{let a=null;const o=e.title,s=e.querySelector("#detailBulletsWrapper_feature_div"),i=e.querySelector(".prodDetTable");if(Ne(o)&&t==="Date"&&(t="Publisher"),s){const l=s.querySelectorAll("ul li");for(const u of l){const c=u.innerText.trim();if(c.toLowerCase().includes(t.toLowerCase())){const d=(n=c.split(":")[1])==null?void 0:n.trim();d&&(t==="Date"||t==="Publisher"?a=d==null?void 0:d.replace(/,/g,"").trim():t==="Manufacturer"?a=d==null?void 0:d.replace(/,/g,"").trim():t==="Best Sellers"&&(a=d==null?void 0:d.split(" ")[0].replace(/[^\d.]/g,"").trim()));break}}}else if(i){const l=e.querySelectorAll(".prodDetTable tbody tr");for(const u of l)if(u.innerText.trim().toLowerCase().includes(t.toLowerCase())){const d=(r=u.querySelector("td"))==null?void 0:r.innerText.trim();d&&(t==="Date"?a=d==null?void 0:d.trim().replace(/,/g,"").replace(/\s+/g," ").trim():t==="Best Sellers"&&(a=d==null?void 0:d.split(" ")[0].replace(/[^\d.]/g,"").trim()));break}}return e=null,a=t==="Publisher"?Te(a):a,a?oe(a):null}catch(a){console.error("Error extractting details!",a)}return null}function Ne(e){if(!e.toLowerCase().includes("books"))return!1;const t=["Camiseta","shirt","T-shirt","Maglietta","hoodie","Sweat à Capuche","Sudadera con Capucha","Felpa con Cappuccio","Débardeur","Camiseta sin Mangas","tanktop","tank top","tank-top","Canotta","Throw Pillow","Camiseta Cuello V","V-Neck","V-Ausschnitt","T-Shirt avec Col en V","Maglietta con Collo a V","Sweatshirt","Tumbler"];for(let n=0;n<t.length;n++)if(e.toLowerCase().includes(t[n].toLowerCase()))return!1;return!0}function Te(e){const t=e.match(/\((.*?)\)/);return t?`${t[1]}`:"N/A"}function Ie(e){try{const t=["#corePrice_feature_div",".priceToPay","#corePriceDisplay_desktop_feature_div",".apexPriceToPay"];for(const n of t){const r=e.querySelector(n);if(r){const a=r.innerText,o=De(a);if(o)return e=null,o}}e=null}catch{console.error("Price not found check zip code")}return null}function De(e){try{const n=e.replace(/\n/g,"").trim().match(/([$€£])(\d+(\.\d{2})?)/);if(n){const r=n[1],a=n[2];return`${r}${a}`.trim()}}catch{}return null}function R(e){return new DOMParser().parseFromString(e,"text/html")}function oe(e){return e?e.replace(/,/g,"").replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"").normalize("NFC").trim():null}function Ae(){var r;const e=document.querySelector(".emr.item-container-row .resultProduct");if(!e)return;const t=(r=e.textContent)==null?void 0:r.split("/");if(!t||t.length<2)return;const n=parseInt(t[1].replace(/[^0-9]/g,""),10);isNaN(n)||(e.textContent=se(n))}function se(e){if(isNaN(e))return e;const t=new URL(window.location.href),n=parseInt(t.searchParams.get("page"),10)||1;return`${Math.min(Math.ceil(e/48)*48,n*48,e).toLocaleString()}/${e.toLocaleString()}`}function Be(e){return typeof e!="string"||e.trim()===""||isNaN(e.trim())||isNaN(e)||e===null||e===void 0?"N/A":"#"+Number(e).toLocaleString()}function F(e){try{if(!e||e.includes("N/A"))return e;const t=new Date(e),n={month:"numeric",day:"numeric",year:"numeric"};return new Intl.DateTimeFormat("en-US",n).format(t)}catch{}}async function A(e){return chrome.runtime.getURL(`img/${e}`)}async function ie(e=null){let t=[],n=[],r=[],a,o,s=e?new URL(e):new URL(window.location.href);console.log("urlbase",s),/^https?:\/\//i.test(s)||(s=`https://${s}`),s.searchParams.set("ref","sr_pg_2"),s.searchParams.set("page",3);let i=0;a=await B(s.href,1);for(let c=0;c<6&&!(a&&a.totalResultCount&&(i=a.totalResultCount,s.searchParams.set("ref",`sr_pg_${Math.floor(i/48)-1}`),s.searchParams.set("page",`${Math.floor(i/48)}`),a=await B(s.href,1),a.totalResultCount===i));c++);if(a&&a.totalResultCount)return v=a.totalResultCount,v;let l=e?new URL(e):new URL(window.location.href);/^https?:\/\//i.test(l)||(l=`https://${l}`),l.searchParams.get("ref")&&l.searchParams.delete("ref"),l.searchParams.set("page",1e3);try{const c=await B(l.href,1);c.apro&&l.searchParams.set("page",Math.ceil(c.apro/48)+9);for(let C=0;C<2;C++){const m=await B(l.href,1);if(m.result&&t.push(m.result),m.apro&&n.push(m.apro),m.lastPage&&r.push(m.lastPage),!m.lastPage){let y=m.apro,f=Math.ceil(m.apro/48);if(m.apro>2e4)for(let w=1;w<=3;w++){l.searchParams.set("page",f>0?f:1);const g=await B(l.href,1);if(g.result&&t.push(g.result),g.apro&&n.push(g.apro),g.lastPage&&r.push(g.lastPage),g.apro===y)break;f=Math.ceil(g.apro/48),y=g.apro}}if($e(n))break}const d=t.length>0?Math.max(...t):0,p=n.length>0?Math.max(...n):0;o=p>=2e4?Math.max(d,p):p}catch(c){console.error(c),o="Error!"}return o===0&&t.length>0&&n.length===0&&r.length===0&&(o=Math.max(...t)),o=o||0,v=o,o}async function qe(){await b(50);const e=document.querySelector(".emr.item-container-row .resultProduct");if(e){let t=await ie(window.location.href);const n=se(t);e.textContent=`${n}`}}function $e(e){for(let t=0;t<e.length-1;t++)if(e[t]===e[t+1])return!0;return!1}async function ke(e,t){var n;try{let r=await K(e,t);const a=/<img[^<>]*id="landingImage"[^<>]*\/?>/,o=/src="([^"]+)"/;let s=r.match(a);const i=s&&((n=s[0].match(o))==null?void 0:n[1])||null;let l=r.match(/<title.*?<\/title>/is);const u=await Re(l?l[0]:null),c=r.replace(/<head.*?<\/head>/is,l?l[0]:"").replace(/<style.*?<\/style>/gs,"").replace(/<script.*?<\/script>/gs,"").replace(/<noscript.*?<\/noscript>/gs,"").replace(/<header.*?<\/header>/gs,"").replace(/href=/gs,"momo=").replace(/src=/gs,"source=").replace(/data-/gs,"mama-").replace(/onload/gs,"onslow");return r=s=l=null,{title:u,image:i,content:c}}catch{return{title:null,image:null}}}async function Re(e){if(!e)return null;const t=["Camiseta","shirt","T-shirt","Maglietta","hoodie","Sweat à Capuche","Sudadera con Capucha","Felpa con Cappuccio","Débardeur","Camiseta sin Mangas","tanktop","tank top","tank-top","Canotta","Throw Pillow","Camiseta Cuello V","V-Neck","V-Ausschnitt","T-Shirt avec Col en V","Maglietta con Collo a V","Sweatshirt","Tumbler"];try{const n=e,r=e==null?void 0:e.split(":");for(const a of r)for(const o of t)if(a.toLowerCase().includes(o.toLowerCase())){if(a.toLowerCase().includes("amazon.")&&a.toLowerCase().includes("|")){const s=a.split("|");for(const i of s)if(i.toLowerCase().includes(o.toLowerCase()))return i.trim().replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"")}return a.trim().replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"")}return r[0].trim()}catch{}return null}async function G(e,t){let n=await K(e,t),r=n.match(/<title.*?<\/title>/is);const a=n.replace(/<head.*?<\/head>/is,r?r[0]:"").replace(/<style.*?<\/style>/gs,"").replace(/<script.*?<\/script>/gs,"").replace(/<noscript.*?<\/noscript>/gs,"").replace(/<header.*?<\/header>/gs,"").replace(/href=/gs,"momo=").replace(/src=/gs,"source=").replace(/data-/gs,"mama-").replace(/onload/gs,"onslow");return n=r=null,a}async function B(e,t){var C;console.log(e);let n=null,r=null,a=await K(e,t),o=a.match(/"totalResultCount":\s*(\d+)/);const s=o?parseInt(o[1],10):null;if(s!==null)return a=o=null,{totalResultCount:s};const i=/(\d{1,3}(?:,\d{3})*)\s*results?/,l=/<span[^<]*?(result|results)[^>]*?<\/span>/gi,u=/(\d{1,3}(,\d{3})*|\d+)-(\d{1,3}(,\d{3})*|\d+)/;let c=null;try{const m=a.match(l)[0];if(m&&m.length>0){const y=m.match(i)[1];if(y){const f=y.replace(/,/g,"");r=isNaN(Number(f))?null:Number(f);try{const w=((C=m.match(u))==null?void 0:C[3])||null;if(w){const g=w.replace(/,/g,"");w&&(c=isNaN(Number(g))?null:Number(g))}}catch{c=0}}}}catch{console.error("No results or bad query!")}const d=/<span[^>]*class=["']s-pagination-item s-pagination-disabled["'][^>]*>(.*?)<\/span>/gi;let p=a.match(d);return p&&p.length>0&&p.forEach((m,y)=>{const f=m.match(/>(.*?)<\/span>/i)[1],w=Number(f);isNaN(w)||(n=w)}),a=o=p=null,{result:r,apro:c,lastPage:n,totalResultCount:s}}function Fe(){return J[Math.floor(Math.random()*J.length)]}async function K(e,t,n=3,r=500){for(let a=0;a<n;a++)try{await b(Math.floor(Math.random()*1)+50);let o=t===0?`/dp/${e.replace(/\s+/g,"").replace(/\u200E/g,"")}`:e,s=await fetch(o,{method:"GET",headers:{"User-Agent":Fe(),"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Clear-Site-Data":"cache","Accept-Encoding":"br, zstd, gzip ,deflate","accept-language":"en-US,en"}});if(!s.ok)throw new Error(`Failed to fetch: ${s.status}`);const i=await s.text();return s=null,i}catch(o){if(console.error(`Attempt ${a+1} failed: ${o}`),a<n-1)await b(r*(a+1));else throw new Error(`Failed to fetch ${t===0?ASIN:"Url"} ${e} after ${n} retries.`)}}We();async function We(){const t=window.location.href.match(/https?:\/\/?(www\.?amazon\.(com|es|fr|it|de|co\.uk))/);t&&(M=`${t[1]}/`,/^https?:\/\//i.test(M)||(M=`https://${M}`))}async function O(){let t=0;for(;t<3;)try{return await new Promise((n,r)=>{const a=chrome.runtime.connect({name:"activeTabId"});a.postMessage({action:"getActiveTabId"}),a.onMessage.addListener(o=>{o&&o.tabId!==void 0?n(o.tabId):(console.error("Failed to retrieve tab ID"),r("Tab ID not found")),a.disconnect()}),a.onDisconnect.addListener(()=>{chrome.runtime.lastError&&(console.error("Disconnected due to an error:",chrome.runtime.lastError.message),r(chrome.runtime.lastError.message))})})}catch{if(t++,t>=3){console.error("All retry attempts failed.");break}await new Promise(r=>setTimeout(r,500))}return null}async function ee(e,t){let r=0,a=!1;for(;r<3;)try{if(!e){console.error("No settings provided.");return}const o=await O();if(!o)throw new Error("Tab ID retrieval failed.");const s=chrome.runtime.connect({name:"saveSettings"});s.postMessage({action:"saveSettings",data:e,tabId:o});const i=setTimeout(()=>{s.disconnect()},3e4),l=await new Promise((u,c)=>{s.onMessage.addListener(d=>{clearTimeout(i),u(d),s.disconnect()}),s.onDisconnect.addListener(()=>{chrome.runtime.lastError?c(new Error(`Disconnected due to an error: ${chrome.runtime.lastError.message}`)):c(new Error("Port disconnected without a response."))})});if(l.status==="success"){!a&&t&&(closeTabAndOpenNew(e.dmUrl),a=!0);return}else throw new Error(`Settings storage failed: ${l.message}`)}catch{if(r++,r>=3){console.error("All retry attempts failed.");break}await new Promise(s=>setTimeout(s,1e3))}}async function He(){try{const e=await O();if(e)return new Promise((t,n)=>{const r=chrome.runtime.connect({name:"retrieveSettings"});r.postMessage({action:"retrieveSettings",tabId:e}),r.onMessage.addListener(a=>{a.status==="success"&&a.message?t(a.message):t(null),r.disconnect()}),r.onDisconnect.addListener(()=>{chrome.runtime.lastError&&(console.error("Disconnected due to an error:",chrome.runtime.lastError.message),n(new Error("Disconnected due to an error")))})});throw new Error("tabId is undefined")}catch(e){return console.error("Retrieving data failed!",e),null}}async function le(){try{const e=await O();if(e)return new Promise((t,n)=>{const r=chrome.runtime.connect({name:"UI"});r.postMessage({action:"getUI",tabId:e}),r.onMessage.addListener(a=>{a.status==="success"&&a.message?t(a.message):t(null),r.disconnect()}),r.onDisconnect.addListener(()=>{chrome.runtime.lastError&&(console.error("Disconnected due to an error:",chrome.runtime.lastError.message),n(new Error("Disconnected due to an error")))})});throw new Error("tabId is undefined")}catch{return null}}const b=e=>new Promise(t=>setTimeout(t,e));async function ze(){const e=document.querySelector("div.loaderContainer");if(e){e.style.display.includes("none")&&(e.style.display="flex",e.classList.add("show"),document.body.style.overflow="hidden");return}const t=document.createElement("div");t.classList.add("loaderContainer","show"),t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height=`${document.documentElement.clientHeight}px`,t.style.backgroundColor="rgba(0, 0, 0, 0.4)",t.style.zIndex="9999",t.innerHTML=`
    <!-- Filter section -->
        <div class="filter-container" id="niche-search-filter" style="display:none">
            <div class="advanced-options">
                <div class="filter-group search">
                    <label>Niche:
                        
                    </label>
                    <input type="text" id='filter-term' placeholder="Enter Niche" class="search-input"/>

                    <div style="display:flex; justify-content:space-between; margin-top:20px">

                
                        <div class="search-filter">
                            <label>Published WithIn:</label>
                        
                            <div style="display:flex;gap:10px">

                            <input type="date" id='minDate' placeholder="Published after MM/DD/YYY e.g 25/12/2024" class="search-input"/>
                            <input type="date" id='maxDate' placeholder="Published after MM/DD/YYY e.g 25/12/2024" class="search-input"/>

                            </div>

                        </div>

                        <div class="search-filter justify-end" style="width:auto;" id="competition-range">
                            <label>Competition Range:</label>
                            <input type="number" id="minCompetition" placeholder="Min" class="min-input">
                            <input type="number" id="maxCompetition" placeholder="Max" class="max-input">
                        </div>

                    </div>

                </div>
                
                
                <div class="filter-group">
                    <label>Price Range:</label>
                    <input type="number" id='minfPrice' placeholder="Min" class="min-input"/>
                    <input type="number" id='maxfPrice' placeholder="Max" class="max-input"/>
                </div>

                <div class="filter-group">
                    <label>BSR Range:</label>
                    <input type="number" id='minBsr' placeholder="Min" class="min-input"/>
                    <input type="number" id='maxBsr' placeholder="Max" class="max-input"/>
                </div>
            </div>

            <div class="filter-actions">
                <button class="btn filter-btn">Filter</button>
                <button class="btn reset-btn">Reset</button>
            </div>
        </div>
    </div>       
    <div class="container" style='overflow:hidden'>
        <div class="header">
            
            <div class="niche-search-container">
                <div class="loader item-container-row">
                    <span class="item-container-row">
                        <label for="firstCount">Pages:</label>
                        <input type="number" value="1" id="firstCount"/>
                        <label for="lastCount">-</label>
                        <input type="number" value="10" id="lastCount"/>
                        <p class="progress">Progress:<i class='progressValue'>0/10</i></p>
                        <button class="filters">Show Filters</button>  
                        <button class="multiload">Load</button>
                    </span>
                </div> 
            </div>
        </div>          
        <div class="body" id="productList">
        </div>
        <button id="closeButton">Close</button>
    </div>
    `,document.body.appendChild(t),await b(1e3);const n=document.querySelector(".loaderContainer button.filters"),r=document.querySelector(".loaderContainer button.multiload"),a=document.querySelector(".loaderContainer button#closeButton"),o=document.querySelector(".loaderContainer button.btn.filter-btn"),s=document.querySelector(".loaderContainer button.btn.reset-btn");n.addEventListener("click",ue),r.addEventListener("click",Ge),a.addEventListener("click",Ze),o.addEventListener("click",Ue),s.addEventListener("click",_e),document.body.style.overflow="hidden",S=document.getElementById("productList"),P.length,S.style.width=S.parentElement.clientWidth-30+"px",S.style.height=S.parentElement.clientHeight-50+"px",Q=Math.ceil(S.clientHeight/(me+fe)),console.log("visible items",Q),X=0;let i;S.addEventListener("scroll",()=>{clearTimeout(i),console.log("scroll occured");const{scrollTop:l,scrollHeight:u,clientHeight:c}=S;i=setTimeout(()=>{l+c>=u-5&&D()},50)}),S.addEventListener("click",l=>{if(l.target.closest(".deletes")){const u=l.target.closest(".deletes"),c=parseInt(u.getAttribute("data-row-index"),10),d=X+c;x.splice(d,1),P.length>0&&P.splice(d,1),D()}}),D()}async function Ve(){const e=document.querySelector("div.winnerContainer");if(e){e.style.display.includes("none")&&(e.style.display="flex",e.classList.add("show"),document.body.style.overflow="hidden");return}const t=document.createElement("div");t.classList.add("winnerContainer","show"),t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height=`${document.documentElement.clientHeight}px`,t.style.backgroundColor="rgba(0, 0, 0, 0.4)",t.style.zIndex="9999",t.innerHTML=`
    <div class="container" style='overflow:hidden'>
        <div class="header">

            <div class="winner-loader-container" style="display:flex;">
                <div class="loader item-container-row" style="border:transparent">

                            
                    <span class="item-container-row" style="gap:30px">
                        <div class="filter-group">
                            <label>Published WithIn</label>
                        
                            <div style="display:flex;gap:10px">

                            <input type="date" id="minDate" placeholder="Published after MM/DD/YYY e.g 25/12/2024" class="search-input">
                            <input type="date" id="maxDate" placeholder="Published after MM/DD/YYY e.g 25/12/2024" class="search-input">

                            </div>

                        </div>


                        <div class="filter-group">
                            <label>BSR (Best Sellers Rank)</label>
                            <input type="number" id="minBsr" placeholder="Min" class="min-input">
                            <input type="number" id="maxBsr" placeholder="Max" class="max-input">
                        </div>
                    </span>

                    <span class="item-container-row" style="margin-top:10px;">
                       
                        <label for="firstPage">Pages:</label>
                        <input type="number" value="1" placeholder="Page 1 " id="firstPage">
                        <label for="lastPage">-</label>
                        <input type="number" value="10" placeholder="Page 10 " id="lastPage">
                        <label for="maxResult">Maximum Competition :</label>
                        <input type="number" value="1000" placeholder="1K" id="maxResult">
                        <p class="progress">Progress:<i class="progressValue">0/10</i></p>
                        <button class="multiload" id="loadWinner">Load</button> 
                    </span>
                </div>


               
            </div>
        </div>          
        <div class="body" id="winnersList">
        </div>
        <button id="closeButton">Close</button>
    </div>
    `,document.body.appendChild(t),await b(1e3);const n=document.querySelector(".winnerContainer button#loadWinner"),r=document.querySelector(".winnerContainer button#closeButton");n.addEventListener("click",Ke),r.addEventListener("click",et),document.body.style.overflow="hidden",I=document.getElementById("winnersList"),I.style.width=I.parentElement.clientWidth-30+"px",I.style.height=I.parentElement.clientHeight-50+"px"}async function Ue(){console.log("filter products",x),U=0;try{if(!Array.isArray(x)||x.length===0)return;P=[],document.querySelector("#productList").innerHTML="";const e=document.querySelector("#niche-search-filter"),t=k(e.querySelector("#minDate").value||"2000/01/01"),n=k(e.querySelector("#maxDate").value||"3000/12/31"),r=parseFloat(e.querySelector("#minBsr").value)||0,a=parseFloat(e.querySelector("#maxBsr").value)||1e7,o=parseFloat(e.querySelector("#minCompetition").value)||0,s=parseFloat(e.querySelector("#maxCompetition").value)||1e7,i=parseFloat(e.querySelector("#minfPrice").value)||0,l=parseFloat(e.querySelector("#maxfPrice").value)||300,u=e.querySelector("#filter-term").value.toUpperCase();let c=0;for(let d=0;d<x.length;d++)try{const p=x[d],C=p.title?p.title.toUpperCase():"",m=p.brand?p.brand.toUpperCase():"",y=await ce(p.date.trim(),0);console.log("product date",y,p.competition),console.log(`
`);const f=parseFloat(p.price.replace(/[^\d\.]/g,""))||0,w=p.bsr==="N/A"?NaN:parseFloat(p.bsr.replace(/[^\d\.]/g,""))||NaN,g=p.competition==="N/A"?NaN:p.competition||NaN;let T=!0;(t&&parseInt(y)<parseInt(t)||n&&parseInt(y)>parseInt(n))&&(T=!1),u&&!(C.includes(u)||m.includes(u))&&(T=!1),(isNaN(f)||f<i||f>l)&&(i!=0||l!=300)&&(T=!1),(isNaN(w)||w<r||w>a)&&(r!=0||a!=1e7)&&(T=!1),(isNaN(g)||g<o||g>s)&&(o!=0||s!=1e7)&&(T=!1),T&&(console.log("matched product",p),P.push(p)),c++,c===100&&(await b(10),c=0)}catch(p){console.error("Error filtering product",p)}if(P.length===0){document.querySelector("#productList").innerHTML='<span class="notFound">NO PRODUCTS FOUND. TRY AGAIN!</span>';return}D()}catch(e){console.error("Filter operation failed:",e)}}async function ce(e,t){try{if(t==0)try{const n=new Date(e);return`
				${n.getFullYear()}${(n.getMonth()+1).toString().padStart(2,"0")}${n.getDate().toString().padStart(2,"0")}`.replace(/[^\d\.]/g,"")}catch{return 0}t==1}catch{}}function _e(){P=[],document.getElementById("minDate").value="",document.getElementById("minBsr").value="",document.getElementById("maxBsr").value="",document.getElementById("minfPrice").value="",document.getElementById("maxfPrice").value="",document.getElementById("filter-term").value="",document.getElementById("minCompetition").value="",document.getElementById("maxCompetition").value="",document.getElementById("maxDate").value="",document.getElementById("minDate").textContent="",document.getElementById("minfPrice").textContent="",document.getElementById("maxfPrice").textContent="",document.getElementById("filter-term").textContent="",ue(),D()}function ue(){const e=document.querySelector(".loaderContainer .filter-container");if(!e)return;const t=e.style.display.includes("none");e.style.display=t?"flex":Ye(e);const n=document.querySelector(".loaderContainer button.filters");n.textContent=t?"Hide Filters":"Show Filters",t&&e.classList.add("show")}function Ye(e){e.classList.remove("show"),setTimeout(()=>{e.style.display="none"},600)}let z=!1,q=!1,E=null;async function Ge(){var a;const e=parseInt(document.querySelector("#firstCount").value)||1,t=parseInt(document.querySelector("#lastCount").value)||10,n=document.querySelector(".loaderContainer .multiload"),r=document.querySelector(".loaderContainer p.progress .progressValue");if(z){je(n);return}await b(200),n.textContent="Pause",v&&!isNaN(v)&&(v=Math.abs(v),E=Math.ceil(v/48+1)),(!E||E==="undefined")&&(E=t),z=!0,q=!1;try{const o=new URL(window.location.href);let s=e;h||(h=await A("loading.gif"));const i=document.createElement("span");for(i.classList.add("notFound"),i.innerHTML=`<img style="width:40px;height:40px" src="${h}"/>`,document.querySelector("#productList").appendChild(i),x.length===0&&(_=[]),s;s<=t&&!q&&s<=E&&(o.searchParams.set("ref",`sr_pg_${s}`),o.searchParams.set("page",s),r.textContent=`${s}/${t}`,!q);s++)await Je(o.href),D(),(a=document.querySelector("#productList .notFound"))==null||a.remove()}catch(o){console.error("Error in loadHandler:",o)}finally{z=!1,q=!1,n.textContent="Load",n.style.pointerEvents=""}}let V=!1,$=!1;async function Ke(){var a;const e=parseInt(document.querySelector("#firstPage").value)||1,t=parseInt(document.querySelector("#lastPage").value)||10,n=document.querySelector(".winnerContainer #loadWinner"),r=document.querySelector(".winnerContainer p.progress .progressValue");if(V){Oe(n);return}await b(200),n.textContent="Pause",v&&!isNaN(v)&&(v=Math.abs(v),E=Math.ceil(v/48+1)),(!E||E==="undefined")&&(E=t),V=!0,$=!1;try{const o=new URL(window.location.href);let s=e;h||(h=await A("loading.gif"));const i=document.createElement("span");for(i.classList.add("notFound"),i.innerHTML=`<img style="width:40px;height:40px" src="${h}"/>`,document.querySelector("#winnersList").appendChild(i),s;s<=t&&!$&&s<=E&&(o.searchParams.set("ref",`sr_pg_${s}`),o.searchParams.set("page",s),r.textContent=`${s}/${t}`,!$);s++)await Qe(o.href),(a=document.querySelector("#winnersList .notFound"))==null||a.remove()}catch(o){console.error("Error loading winners:",o)}finally{V=!1,$=!1,n.textContent="Load",n.style.pointerEvents=""}}function Oe(e){$=!0,e.style.pointerEvents="none"}function je(e){q=!0,e.style.pointerEvents="none"}async function Je(e){const n=(await pe(e)).map(r=>ot(r));return await Promise.all(n),!0}async function Qe(e){const n=(await pe(e)).map(r=>Xe(r));return await Promise.all(n),!0}const k=e=>{let t=e.split("-").join("/");return t.split("/")[0]+t.split("/")[1]+t.split("/")[2]};async function Xe(e){var t;try{const n=await ke(e,0);if(console.log("product data",n),!n||!n.title||n.title==="undefined")return;const r=await ae(n.title);console.log("new result",r);let a=`${M}dp/${e}`;/^https?:\/\//i.test(a)||(a=`https://${a}`);const o=n.image||"N/A",s=(t=document.querySelector("#maxResult"))==null?void 0:t.value;let i=parseInt(s,10);isNaN(i)||i<=0?i=1e3:i=Math.abs(i);const l=document.querySelector(".winner-loader-container");if(typeof r=="number"&&r<=i){console.log("addWinner competition",r),console.log("maxResult",i);let u=R(n.content),c=Y(u,e);console.log(c);const d=await ce(c.date.trim(),0),p=k(l.querySelector("#minDate").value||"2000/01/01"),C=k(l.querySelector("#maxDate").value||"3000/12/31"),m=parseFloat(l.querySelector("#minBsr").value)||0,y=parseFloat(l.querySelector("#maxBsr").value)||1e7,f=c.bsr==="N/A"?NaN:parseFloat(c.bsr.replace(/[^\d\.]/g,""))||NaN;if((isNaN(f)||f<m||f>y)&&(m!=0||y!=1e7)){console.log("failed bsr",f,m,y);return}if(p&&parseInt(d)<parseInt(p)||C&&parseInt(d)>parseInt(C))return;tt(new rt(n.title,a,e,r,o,c.bsr,c.date))}return}catch(n){console.error(`Error loading product for ASIN ${e}:`,n)}}function Ze(){const e=document.querySelector("div.loaderContainer");e&&(e.classList.remove("show"),setTimeout(()=>{e.style.display="none",document.body.style.overflow="auto"},600))}function et(){const e=document.querySelector("div.winnerContainer");e&&(e.classList.remove("show"),setTimeout(()=>{e.style.display="none",document.body.style.overflow="auto"},600))}function D(){const t=P.length===0?x:P;console.log(x);const n=U*j,r=n+j,a=t.slice(n,r);console.log("index",n,r),a.length>0&&(a.forEach(o=>{const s=document.createElement("div");s.className="item",s.innerHTML=`<div class="research-info">
                    <img src="${o.img}" alt="" class="img-fluid rounded" width="80" style="">
                    <div>
                        <p><strong>Title:</strong><a href="${o.ahref}" data-image="${o.img}" target="_blank"> ${de(o.title,100)}</a></p>
                        <p><strong>Brand:</strong> ${o.brand}</p>
                        <p><strong class="entities">BSR (Best Sellers Rank):</strong><span class="bsr">${Be(o.bsr)}</span></p>
                        <p><strong>Price:</strong> ${o.price}</p>
                        <p><strong class="entities">Publication Date:</strong><span class="bsr">${F(o.date)}</span></p>
                        <p style="justify-content: space-between !important;">
                            <span class='asin'><strong class="entities">ASIN:</strong> ${o.asin}</span>
                            <button class='deletes' style="cursor: pointer">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                                <path d="M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 0 1 0 2h-1v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7H4a1 1 0 0 1 0-2h4V4a1 1 0 0 1 1-1zm1 2v1h4V5h-4zM7 7v14h10V7H7zm2.5 3a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0v-7a1 1 0 0 1 1-1zm5 0a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0v-7a1 1 0 0 1 1-1z"/>
                                </svg>

                            </button> 
                        </p>
                    </div>
                </div>`,S.appendChild(s)}),U++)}function de(e,t){return e.length>t?e.slice(0,t)+"...":e}function tt(e){const t=document.createElement("div");t.classList.add("item"),t.style.position="relative",t.style.width="calc(100% - 40px)",t.style.left="0",t.style.padding="10px";const n=e.title.replace(/<\/?title>/gi,"").trim();t.innerHTML=`
        <div class="research-info">
            <img src="${e.image}" alt="" class="img-fluid rounded" width="80" style="">
            <div>
                <p><strong>Title:</strong><a href="${e.ahref}" data-image="${e.image}" target="_blank"> ${de(n,100)}</a></p>
                <p><strong class="entities">BSR (Best Sellers Rank):</strong><span class="bsr">${e.bsr}</span></p>
                <p><strong class="entities">Publication Date:</strong><span class="bsr">${F(e.date)}</span></p>
                <p style="justify-content: space-between !important;">
                    <span class='asin'><strong class="entities">ASIN:</strong> ${e.asin}</span>
                    <button class='delete' style="cursor: pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M9 3h6a1 1 0 0 1 1 1v1h4a1 1 0 0 1 0 2h-1v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V7H4a1 1 0 0 1 0-2h4V4a1 1 0 0 1 1-1zm1 2v1h4V5h-4zM7 7v14h10V7H7zm2.5 3a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0v-7a1 1 0 0 1 1-1zm5 0a1 1 0 0 1 1 1v7a1 1 0 1 1-2 0v-7a1 1 0 0 1 1-1z"/>
                        </svg>

                    </button> 
                </p>
            </div>
        </div>
    `,I.appendChild(t),t.querySelector(".delete").addEventListener("click",()=>{t.remove()}),nt(t)}function nt(e){try{const t=e.querySelector(".research-info p a");console.log("tr",t),t.addEventListener("mouseover",function(){if(!t.getAttribute("data-image"))return;let n=document.querySelector(".popup");n&&n.remove();const r=t.getBoundingClientRect(),a=t.getAttribute("data-image"),o=document.documentElement,s=document.createElement("div");s.classList.add("popup","arrow"),s.innerHTML=`<div class="popup-wrapper"><img src="${a}" alt="Preview of ${t.textContent.trim()}" /></div>`,s.style.position="absolute";let i=r.right+10,l=r.top-20,u=20;document.querySelector(".winnerContainer").appendChild(s),r.top>300&&(l=r.top-270,u=270),i+s.offsetWidth>window.innerWidth&&(i=r.left-s.offsetWidth),s.style.left=i+"px",s.style.top=l+"px",o.style.setProperty("--arrow",u+"px"),t.addEventListener("mouseout",c=>{s.contains(c.relatedTarget)||s.remove()},{once:!0})})}catch(t){console.error(t)}}class rt{constructor(t,n,r,a,o,s,i){this.title=this.cleanString(t),this.asin=this.cleanString(r),this.ahref=this.cleanString(n),this.competition=this.cleanString(a),this.image=this.cleanString(o),this.bsr=s,this.date=i}cleanString(t){return typeof t=="string"?t.replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"").normalize("NFC"):t}}class at{constructor(t,n,r,a,o,s,i,l,u){this.title=this.cleanString(t),this.date=this.cleanString(a),this.asin=this.cleanString(s),this.bsr=this.cleanString(o),this.ahref=this.cleanString(n),this.img=this.cleanString(r),this.price=this.cleanString(i),this.brand=this.cleanString(l),this.competition=this.cleanString(u)}cleanString(t){return typeof t=="string"?t.replace(/[\u200E\u200F\u202A-\u202E\u2066-\u2069\u200B\u200C\u2028\u2029]/g,"").normalize("NFC"):t}}async function pe(e){const t=new Set;let n=await G(e,1);return R(n).querySelectorAll(".s-result-item.s-asin").forEach(a=>{const o=a.getAttribute("mama-asin");o&&o.length>4&&!_.includes(o)&&t.add(o)}),Array.from(t)}async function ot(e){let t=await G(e,0);!t||t==="undefined"||(await st(t,e),t=null)}async function st(e,t){try{let n=R(e),r=Y(n,t);const a=await ae(r.title);r&&(r.competition=a,x.push(r),_.push(r.asin)),n=r=null,await b(20)}catch(n){console.error("Error processing product details",n)}}
